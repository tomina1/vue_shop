# This is a basic workflow to help you get started with Actions

name: CI

run-name: ${{ github.actor }} is update repo, start building...

# 运行触发器
on:
  # push 推送
  push:
    branches: [ "master" ]
  # pr 合并提交
  pull_request:
    branches: [ "master" ]

  # 循序您从操作选修卡手动运行此工作流
  workflow_dispatch:

# 设置权限(文件可以被读写修改的)
permissions:
  contents: write
  # page 读写
  pages: write
  #openId
  id-token: write

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # 初始化缓存
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: checout
        uses: actions/checkout@v3
      
      - name: cache node_modules
        id: node_modules_cache_id
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ hashFiles('packages.json') }}-node_module


  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: setup

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # 将代码仓库内容拉取 (或称为检出) 到工作目录
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node Version
        uses: actions/setup-node@v3
        with:
          node-version: 20
      
      - name: Npm installing ...
        run: npm install
      
      # 还原保存依赖
      - name: restore cache from node_modules
        id: node_modules_cache_id
        uses: actions/cache@v3
        with:
          path: "node_modules"
          key: ${{ runner.os }}-${{ hashFiles('packages.json') }}-node_module

      - name: Building ....
        run: npm run build
      
      # 上传构建物
      - name: Uploading build artifacts ...
        uses: actions/upload-pages-artifact@v2
        with:
          path: "./dist"

  # 发布
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    # 部署
    - name: Deploy to Github Pages
      # uses: actions/deploy-pages@v2 #自动部署
      uses: peaceiris/actions-gh-pages@v4 #部署并创建 gh-pages 分支
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        force_orphan: true
